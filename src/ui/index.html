<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Maple :: Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Nunito" rel="stylesheet">
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">

    <style>
        body {
            font-family: Nunito, sans-serif;
            font-size: .95rem;
            font-weight: 400;
            line-height: 1.5;
        }
    </style>

</head>
<script>
    window.addEventListener('load', () => {
        main();
    })

    function main() {

        setInterval(() => {
            axios.get('/api/processes')
                .then(resp => {
                    let data = '';

                    resp.data.forEach((item, i) => {

                        data += "<tr class=\"bg-white border border-gray-200\">";
                        data += "   <td class='w-4 px-3 py-2'>" + i + "</td>";
                        data += "   <td class='w-2/5 px-4 py-2'>" + item.name + "</td>";
                        data += "   <td class='w-3/5 px-1 py-2'><pre>" + item.command + "</pre></td>";
                        data += "   <td class='w-12 px-5 py-2'>" + statusPill(item.status) + "</td>";
                        data += "   <td class='w-12 px-1 py-2'>" + fuzzyTime(item.started_at) + "</td>";
                        data += "   <td class='w-12 px-1 py-2'>"+formattedAttempt(item)+"</td>";
                        data += "</tr>";
                    });

                    document.querySelector('#tablecontent').innerHTML = data;

                    // console.log(resp.data);
                })
                .catch(e => console.error(e.message));
        },1000);
    }

    function formattedAttempt(item) {

        if(item.retries===0 && item.currentRetry===0) {
            return '';
        }

        let max = (item.retries===-1) ? '&infin;' : item.retries;

        return '<span class="text-sm text-gray-400">'+item.currentRetry+" / "+max+'</span>';
    }

    function statusPill(label) {

        if (label === "Finished") {
            return "<div class=\"py-2 px-4 shadow-md no-underline rounded-full bg-blue-800 text-white font-sans font-semibold text-sm border-blue btn-primary hover:text-white hover:bg-blue-light focus:outline-none active:shadow-none mr-2\">Finished</div>";
        }

        if (label === "Running") {
            return "<div class=\"py-2 px-4 shadow-md no-underline rounded-full bg-green-600 text-white font-sans font-semibold text-sm border-blue btn-primary hover:text-white hover:bg-blue-light focus:outline-none active:shadow-none mr-2\">Running</div>";
        }

        if (label === "Crashed") {
            return "<div class=\"py-2 px-4 shadow-md no-underline rounded-full bg-red-600 text-white font-sans font-semibold text-sm border-blue btn-primary hover:text-white hover:bg-blue-light focus:outline-none active:shadow-none mr-2\">Crashed</div>";
        }

        return label;
    }

    function fuzzyTime(data) {

        // let data = "2021-01-18T20:30:00";
        // const ts = Date.parse(data);
        // console.log(ts,data);

        return '<span class="text-sm text-gray-400">' + timeDifference(data, 'en') + '</span>';
    }

    function timeDifference(timestamp, locale) {

        const msPerMinute = 60 * 1000;
        const msPerHour = msPerMinute * 60;
        const msPerDay = msPerHour * 24;

        const current = Date.now();
        const elapsed = current - timestamp;

        const rtf = new Intl.RelativeTimeFormat(locale, {numeric: "auto"});

        if (elapsed < msPerMinute) {
            return rtf.format(-Math.floor(elapsed / 1000), 'seconds');
        } else if (elapsed < msPerHour) {
            return rtf.format(-Math.floor(elapsed / msPerMinute), 'minutes');
        } else if (elapsed < msPerDay) {
            return rtf.format(-Math.floor(elapsed / msPerHour), 'hours');
        } else {
            return new Date(timestamp).toLocaleDateString(locale);
        }
    }

    function openLogModal(title) {
        document.querySelector('#modal-title').innerHTML = "Recent evens for "+title;
        document.querySelector('#modal-content').innerHTML = "";

        document.querySelector('#modal').style.display = "block";

        // Add listener
        logWatcher = setInterval(() => {
            
            const url = '/api/log/'+title;
            axios.get(url)
                .then(resp => {
                    let lines = resp.data.log
                        .map(line => {
                            if(line.msg !== "") {
                                let channel = line.channel.replace('std','');

                                let prefix;
                                if(channel=="out") {
                                    prefix = '<span class="text-gray-400">[Out]</span>';
                                } else {
                                    prefix = '<span class="text-red-400">[Err]</span>';
                                }

                                return prefix+"&nbsp;<span class='text-white'>"+line.msg+"</span>";

                            } else {
                                return "";
                            }
                        })
                        .filter(line => line!=="")
                        .join('<br />');

                    document.querySelector('#modal-content').innerHTML = lines;
                })
                .catch(e => {
                    console.error(e);
                })

        },250);
    }

    function closeLogModal() {

        document.querySelector('#modal').style.display = 'none';

        // Remove Listener
        clearInterval(logWatcher);
    }

</script>
<body class="bg-gray-100">

<div class="header w-full h-18 p-4 border-b border-gray-200 mb-0 lg:mb-6 flex bg-red-600 text-white">
    <div class="w-10 h-10 mr-4">
        <?xml version="1.0" encoding="UTF-8"?>
        <svg fill="white" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"
             xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
            <!-- Generated by Pixelmator Pro 2.0.3 -->
            <g id="group">
                <g id="group-1">
                    <path id="Path"
                          d="M494.932 271.274 L464.647 248.564 488.813 192.17 C490.181 188.981 489.589 185.293 487.3 182.692 485.002 180.087 481.405 179.047 478.089 179.995 L423.01 195.732 408.058 158.346 C406.935 155.543 404.479 153.491 401.523 152.885 398.562 152.297 395.501 153.201 393.365 155.332 L334.335 214.362 363.572 82.789 C364.305 79.499 363.133 76.078 360.537 73.925 357.945 71.771 354.362 71.258 351.265 72.587 L297.121 95.788 264.441 5.912 C263.149 2.364 259.776 0 256 0 252.224 0 248.851 2.364 247.557 5.912 L214.877 95.788 160.733 72.587 C157.632 71.258 154.058 71.771 151.461 73.925 148.864 76.079 147.693 79.499 148.426 82.789 L177.663 214.362 118.633 155.332 C116.501 153.2 113.449 152.297 110.475 152.885 107.519 153.49 105.063 155.543 103.94 158.346 L88.988 195.732 33.91 179.994 C30.577 179.047 26.998 180.086 24.699 182.691 22.41 185.292 21.817 188.98 23.186 192.169 L47.352 248.563 17.067 271.273 C14.878 272.913 13.558 275.457 13.479 278.194 13.4 280.931 14.567 283.545 16.654 285.317 L129.381 380.702 121.438 420.412 C120.859 423.307 121.736 426.307 123.793 428.421 125.845 430.544 128.236 431.491 131.161 431.035 L227.928 414.816 227.928 485 C227.928 499.886 240.016 512 254.875 512 269.735 512 281.822 499.886 281.822 485 L281.822 414.816 379.712 431.035 C382.629 431.491 385.87 430.544 387.922 428.421 389.979 426.307 390.997 423.307 390.418 420.412 L382.545 380.702 495.307 285.317 C497.395 283.545 498.596 280.931 498.517 278.194 498.441 275.458 497.121 272.914 494.932 271.274 Z M366.968 370.405 C364.472 372.519 363.323 375.817 363.964 379.028 L370.394 411.177 275.443 395.353 C272.838 394.914 269.614 395.651 267.597 397.362 265.584 399.064 263.86 401.573 263.86 404.213 L263.86 485 C263.86 489.983 259.829 494.035 254.878 494.035 249.926 494.035 245.896 489.983 245.896 485 L245.896 404.211 C245.896 401.571 245.295 399.062 243.282 397.36 241.646 395.974 239.866 395.228 237.756 395.228 237.265 395.228 236.909 395.272 236.418 395.351 L141.537 411.175 148.002 379.026 C148.642 375.815 147.511 372.517 145.015 370.403 L36.857 278.879 63.773 258.695 C67.084 256.213 68.271 251.783 66.639 247.976 L47.136 202.459 91.847 215.231 C96.316 216.52 100.948 214.209 102.658 209.933 L115.561 177.666 186.771 248.88 C189.595 251.705 193.942 252.327 197.442 250.406 200.946 248.485 202.758 244.476 201.889 240.582 L169.764 95.999 216.531 116.043 C218.807 117.021 221.373 117.025 223.641 116.03 225.904 115.052 227.667 113.179 228.514 110.859 L256 35.267 283.487 110.858 C284.334 113.178 286.097 115.051 288.36 116.029 290.632 117.016 293.198 117.011 295.47 116.042 L342.237 95.998 310.11 240.58 C309.242 244.475 311.053 248.483 314.557 250.404 318.048 252.325 322.408 251.702 325.228 248.878 L396.438 177.664 409.341 209.931 C411.052 214.207 415.687 216.51 420.152 215.229 L464.862 202.457 445.358 247.974 C443.727 251.781 444.911 256.211 448.222 258.693 L475.134 278.877 Z"
                          fill-opacity="1" stroke="none"/>
                </g>
            </g>
        </svg>
    </div>

    <h4 class="font-medium text-2xl">Maple</h4>
</div>

<div class="flex">

    <div class="w-3/12"></div>

    <div class="w-full flex">

        <div class="w-full bg-white shadow-xl">

            <div class="mb-4 px-6 py-6">
                <h4 class="text-xl">Processes</h4>
            </div>

            <table class="w-full table-auto mb-6">

                <thead class="justify-between">
                <tr class="bg-gray-100">
                    <th class="px-2 py-2">
                        <span class="text-gray-600">#</span>
                    </th>
                    <th class="px-2 py-2">
                        <span class="text-gray-600">Name</span>
                    </th>
                    <th class="px-8 py-2">
                        <span class="text-gray-600">Command</span>
                    </th>
                    <th class="px-4 py-2">
                        <span class="text-gray-600">Status</span>
                    </th>

                    <th class="px-16 py-2">
                        <span class="text-gray-600">Started</span>
                    </th>

                    <th class="px-4 py-2">
                        <span class="text-gray-600">Attempt</span>
                    </th>

                </tr>
                </thead>

                <tbody class="bg-gray-200" id="tablecontent">
                </tbody>

            </table>

        </div>
    </div>

    <div class="w-0 lg:w-3/12"></div>

</div>

<!-- Log modal -->
<div id="modal" class="fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true" style="display: none;">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">

      <div onclick="closeLogModal()" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
  
      <!-- This element is to trick the browser into centering the modal contents. -->
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
  
      <!-- Start of modal -->
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle max-w-10/12">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
              
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>

              <div class="mt-2">
                <p class="text-sm text-gray-500">
                  Recent events, size can be configed in maple-file.
                  <pre id="modal-content" class="mt-2 bg-black pl-2 pt-2 pr-1 pb-1 text-gray-200 w-full overflow-y-auto max-h-96 rounded">
                  </pre>
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button onclick="closeLogModal()" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>